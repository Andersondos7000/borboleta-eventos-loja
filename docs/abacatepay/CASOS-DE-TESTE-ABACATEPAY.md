# üìã Casos de Teste - AbacatePay Integration

## üéØ Vis√£o Geral

Este documento cont√©m casos de teste validados para a integra√ß√£o com AbacatePay, incluindo dados de teste v√°lidos, cen√°rios de erro e fluxos completos.

## ‚úÖ Valida√ß√£o de CPF/CNPJ Implementada

### Funcionalidades Adicionadas

1. **Valida√ß√£o de CPF/CNPJ** em `src/lib/utils.ts`:
   - `validateCPF(cpf: string)`: Valida CPF usando algoritmo oficial
   - `validateCNPJ(cnpj: string)`: Valida CNPJ usando algoritmo oficial
   - `validateDocument(document: string, type: 'cpf' | 'cnpj')`: Valida√ß√£o unificada
   - `formatCPF(cpf: string)`: Formata√ß√£o autom√°tica (000.000.000-00)
   - `formatCNPJ(cnpj: string)`: Formata√ß√£o autom√°tica (00.000.000/0000-00)
   - `formatDocument(document: string, type: 'cpf' | 'cnpj')`: Formata√ß√£o unificada

2. **Integra√ß√£o nos Formul√°rios**:
   - `src/pages/Checkout.tsx`: Schema de valida√ß√£o atualizado
   - `src/components/checkout/CustomerInformation.tsx`: Valida√ß√£o em tempo real
   - `src/components/checkout/ParticipantsList.tsx`: Valida√ß√£o de CPF dos participantes

### Valida√ß√£o em Tempo Real

- **Campo CPF/CNPJ**: Formata√ß√£o autom√°tica durante digita√ß√£o
- **Feedback Visual**: Mensagens de erro claras para documentos inv√°lidos
- **Valida√ß√£o Condicional**: Baseada no tipo de pessoa (F√≠sica/Jur√≠dica)

## üß™ Casos de Teste Validados

### Status dos Testes

#### ‚úÖ Casos Validados
- ‚úÖ **Cria√ß√£o de pagamento PIX** - Funcionando (Payment ID: `bill_k22mLMffhZJWkBj1mmJBpBdL`)
- ‚úÖ **Processamento de webhook** - Funcionando via Ultrahook
- ‚ö†Ô∏è **Verifica√ß√£o de status** - Erro 404 (endpoint precisa revis√£o)
- ‚ö†Ô∏è **Simula√ß√£o de pagamento** - Erro 404 (endpoint precisa revis√£o)
- ‚ùå **Valida√ß√£o de CPF/CNPJ** - Erro no script (precisa corre√ß√£o)

### 1. Cria√ß√£o de Pagamento PIX - Sucesso

**Endpoint**: `POST /functions/v1/create-abacate-payment`

**Dados V√°lidos**:
```json
{
  "amount": 2500,
  "customer_data": {
    "firstName": "Jo√£o",
    "lastName": "Silva",
    "personType": "individual",
    "cpf": "11144477735",
    "email": "joao.silva@email.com",
    "phone": "11999887766",
    "country": "Brasil",
    "zipCode": "01310-100",
    "address": "Av. Paulista",
    "number": "1000",
    "neighborhood": "Bela Vista",
    "city": "S√£o Paulo",
    "state": "SP"
  },
  "items": [
    {
      "name": "Ingresso VIP",
      "quantity": 1,
      "price": 2500
    }
  ]
}
```

**Resposta Esperada**:
```json
{
  "success": true,
  "orderId": "uuid-do-pedido",
  "paymentData": {
    "id": "pix_char_...",
    "qrCode": "00020126...",
    "qrCodeImage": "data:image/png;base64,...",
    "expiresAt": "2025-08-09T02:21:45.018Z",
    "amount": 2500,
    "description": "Pedido #... - Borboleta Eventos"
  }
}
```

### 2. CPFs V√°lidos para Teste

```
11144477735  ‚úÖ V√°lido
12345678909  ‚úÖ V√°lido
98765432100  ‚úÖ V√°lido
```

### 3. CPFs Inv√°lidos (Casos de Erro)

```
12345678901  ‚ùå Inv√°lido - Retorna "Invalid taxId"
11111111111  ‚ùå Inv√°lido - Sequ√™ncia repetida
00000000000  ‚ùå Inv√°lido - Zeros
123.456.789-01  ‚ùå Inv√°lido - Com formata√ß√£o
```

### 4. Verifica√ß√£o de Status de Pagamento

**Endpoint**: `POST /functions/v1/check-abacate-payment`

**Dados**:
```json
{
  "transactionId": "pix_char_JSYsaZrQMepabkmLpGBmRYfm"
}
```

**Resposta**:
```json
{
  "success": true,
  "data": {
    "id": "pix_char_JSYsaZrQMepabkmLpGBmRYfm",
    "status": "PENDING",
    "amount": 1000,
    "expiresAt": "2025-08-09T02:21:45.018Z"
  }
}
```

## üîÑ Fluxo Completo de Teste

### Cen√°rio: Compra de Ingresso com PIX

1. **Preencher Checkout**:
   - Nome: Jo√£o Silva
   - CPF: 11144477735 (ser√° formatado automaticamente)
   - Email: joao.silva@email.com
   - Endere√ßo completo

2. **Criar Pagamento**:
   ```bash
   # PowerShell
   $headers = @{ 'Authorization' = "Bearer $env:SUPABASE_SERVICE_ROLE_KEY"; 'Content-Type' = 'application/json' }
   $body = '{ "amount": 2500, "customer_data": { "firstName": "Jo√£o", "lastName": "Silva", "personType": "individual", "cpf": "11144477735", "email": "joao.silva@email.com" }, "items": [{ "name": "Ingresso VIP", "quantity": 1, "price": 2500 }] }'
   Invoke-RestMethod -Uri 'https://pxcvoiffnandpdyotped.supabase.co/functions/v1/create-abacate-payment' -Method POST -Headers $headers -Body $body
   ```

3. **Exibir QR Code**: Modal com c√≥digo PIX e QR Code

4. **Simular Pagamento** (Ambiente de Desenvolvimento):
   ```bash
   # Simular pagamento via API AbacatePay
   $headers = @{ 'Authorization' = "Bearer $env:ABACATE_PAY_API_KEY"; 'Content-Type' = 'application/json' }
   Invoke-RestMethod -Uri 'https://api.abacatepay.com/v1/pixQrCode/simulate-payment' -Method POST -Headers $headers -Body '{"id": "pix_char_ID_DO_PAGAMENTO"}'
   ```

5. **Verificar Status**:
   ```bash
   # Verificar se pagamento foi aprovado
   $body = '{"transactionId": "pix_char_ID_DO_PAGAMENTO"}'
   Invoke-RestMethod -Uri 'https://pxcvoiffnandpdyotped.supabase.co/functions/v1/check-abacate-payment' -Method POST -Headers $headers -Body $body
   ```

6. **Webhook Autom√°tico**: AbacatePay notifica mudan√ßa de status

## üö® Cen√°rios de Erro Comuns

### 1. CPF Inv√°lido
**Erro**: `{"statusCode":400,"error":"Bad Request","message":"Invalid taxId"}`
**Solu√ß√£o**: Usar CPF v√°lido da lista de testes

### 2. Token de API Inv√°lido
**Erro**: `{"statusCode":401,"error":"Unauthorized"}`
**Solu√ß√£o**: Verificar `ABACATE_PAY_API_KEY` nas vari√°veis de ambiente

### 3. Campos Obrigat√≥rios
**Erro**: `{"statusCode":400,"error":"Bad Request","message":"Missing required field"}`
**Solu√ß√£o**: Verificar se todos os campos obrigat√≥rios est√£o preenchidos

### 4. Valor M√≠nimo
**Erro**: Valor deve ser maior que R$ 1,00 (100 centavos)
**Solu√ß√£o**: Usar `amount >= 100`

## üîß Configura√ß√£o de Ambiente

### Vari√°veis Necess√°rias

```env
# AbacatePay
ABACATEPAY_API_KEY="abc_dev_LsWsb5rG4YSsKL2KCyP3Hm4n"
ABACATEPAY_WEBHOOK_SECRET="cust_WXZjN2KjwbqtkUbnufkyPHLL"

# Supabase
SUPABASE_URL="https://pxcvoiffnandpdyotped.supabase.co"
SUPABASE_SERVICE_ROLE_KEY="eyJhbGciOiJIUzI1NiIs..."
```

### Comandos de Deploy

```bash
# Deploy das fun√ß√µes
supabase functions deploy create-abacate-payment
supabase functions deploy check-abacate-payment
supabase functions deploy abacate-webhook

# Configurar secrets
supabase secrets set ABACATE_PAY_API_KEY=abc_dev_LsWsb5rG4YSsKL2KCyP3Hm4n
supabase secrets set ABACATEPAY_WEBHOOK_SECRET=cust_WXZjN2KjwbqtkUbnufkyPHLL
```

## üìä Monitoramento e Logs

### Logs das Edge Functions

```bash
# Visualizar logs em tempo real
supabase functions logs create-abacate-payment
supabase functions logs abacate-webhook
```

### M√©tricas Importantes

- **Taxa de Sucesso**: > 95% para cria√ß√£o de pagamentos
- **Tempo de Resposta**: < 2s para cria√ß√£o de PIX
- **Webhook Delivery**: < 30s ap√≥s confirma√ß√£o do pagamento

## üéØ Pr√≥ximos Passos

### Prioridade Alta ‚ö°
1. **Revisar documenta√ß√£o da API** para endpoints corretos:
   - Verifica√ß√£o de status: `GET /v1/billing/get?id={id}` retorna 404
   - Simula√ß√£o de pagamento: `POST /v1/billing/simulate-payment` retorna 404
2. **Corrigir valida√ß√£o de CPF** no script de teste
3. **Testar webhook real** com pagamento PIX efetivo

### Prioridade M√©dia üìã
4. **Implementar Retry Logic**: Para webhooks falhados
5. **Adicionar Logs Estruturados**: Para melhor observabilidade
6. **Criar Testes Automatizados**: E2E com Playwright

### Prioridade Baixa üìù
7. **Implementar Rate Limiting**: Para prote√ß√£o da API
8. **Adicionar M√©tricas**: Prometheus/Grafana
9. **Documentar fluxos de erro** para suporte ao cliente

## üìö Refer√™ncias

- [Documenta√ß√£o AbacatePay](https://docs.abacatepay.com/)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)
- [Valida√ß√£o de CPF/CNPJ](https://www.receita.fazenda.gov.br/)

---

**√öltima Atualiza√ß√£o**: 09/08/2025 22:33:51
**Respons√°vel**: Equipe de Desenvolvimento
**Status**: ‚úÖ Integra√ß√£o principal funcionando - Ajustes secund√°rios pendentes

**Teste realizado**: Script `test-abacatepay-flow.ps1` executado com sucesso
**Resultado detalhado**: Ver `RESULTADOS-TESTE-ABACATEPAY.md`