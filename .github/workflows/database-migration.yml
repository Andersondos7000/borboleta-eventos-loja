name: Database Migration Pipeline

# Pipeline CI/CD para migraÃ§Ã£o automatizada de banco de dados
# Reduz tempo de migraÃ§Ã£o atravÃ©s de automaÃ§Ã£o e paralelizaÃ§Ã£o

on:
  workflow_dispatch:
    inputs:
      migration_type:
        description: 'Tipo de migraÃ§Ã£o'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - schema-only
          - data-only
          - validation-only
      environment:
        description: 'Ambiente de destino'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      dry_run:
        description: 'Executar em modo dry-run'
        required: false
        default: true
        type: boolean
      skip_backup:
        description: 'Pular backup (apenas staging)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  SUPABASE_CLI_VERSION: 'latest'

jobs:
  # Job 1: PreparaÃ§Ã£o e validaÃ§Ã£o
  preparation:
    name: ğŸ” PreparaÃ§Ã£o e ValidaÃ§Ã£o
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      migration-id: ${{ steps.setup.outputs.migration-id }}
      backup-required: ${{ steps.setup.outputs.backup-required }}
      
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          npm install -g supabase@${{ env.SUPABASE_CLI_VERSION }}
          
      - name: ğŸ” Configurar credenciais
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase login --token $SUPABASE_ACCESS_TOKEN
          supabase link --project-ref $SUPABASE_PROJECT_ID
          
      - name: âš™ï¸ Setup migraÃ§Ã£o
        id: setup
        run: |
          MIGRATION_ID="migration_$(date +%Y%m%d_%H%M%S)"
          echo "migration-id=$MIGRATION_ID" >> $GITHUB_OUTPUT
          
          # Determinar se backup Ã© necessÃ¡rio
          if [[ "${{ inputs.environment }}" == "production" ]] || [[ "${{ inputs.skip_backup }}" == "false" ]]; then
            echo "backup-required=true" >> $GITHUB_OUTPUT
          else
            echo "backup-required=false" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ” Validar ambiente
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node scripts/validate-migration.js --environment-check
          
      - name: ğŸ“Š AnÃ¡lise de impacto
        run: |
          echo "ğŸ” Analisando impacto da migraÃ§Ã£o..."
          node -e "
            const fs = require('fs');
            const schema = JSON.parse(fs.readFileSync('database-schema-comparison.md', 'utf8'));
            console.log('ğŸ“‹ Tabelas afetadas:', Object.keys(schema.tables || {}).length);
            console.log('â±ï¸ Tempo estimado:', schema.estimatedTime || 'N/A');
          "

  # Job 2: Backup (condicional)
  backup:
    name: ğŸ’¾ Backup do Banco de Dados
    runs-on: ubuntu-latest
    needs: preparation
    if: needs.preparation.outputs.backup-required == 'true'
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar Supabase CLI
        run: npm install -g supabase@${{ env.SUPABASE_CLI_VERSION }}
        
      - name: ğŸ” Configurar credenciais
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase login --token $SUPABASE_ACCESS_TOKEN
          supabase link --project-ref $SUPABASE_PROJECT_ID
          
      - name: ğŸ’¾ Criar backup
        env:
          MIGRATION_ID: ${{ needs.preparation.outputs.migration-id }}
        run: |
          mkdir -p backups
          supabase db dump > "backups/backup_${MIGRATION_ID}.sql"
          
          # Verificar se backup foi criado com sucesso
          if [[ ! -s "backups/backup_${MIGRATION_ID}.sql" ]]; then
            echo "âŒ Backup falhou ou estÃ¡ vazio"
            exit 1
          fi
          
          echo "âœ… Backup criado: backup_${MIGRATION_ID}.sql"
          ls -lh "backups/backup_${MIGRATION_ID}.sql"
          
      - name: ğŸ“¤ Upload backup
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ needs.preparation.outputs.migration-id }}
          path: backups/
          retention-days: 30

  # Job 3: GeraÃ§Ã£o de scripts (paralelo ao backup)
  generate-scripts:
    name: ğŸ“ Gerar Scripts de MigraÃ§Ã£o
    runs-on: ubuntu-latest
    needs: preparation
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
        
      - name: ğŸ“ Gerar scripts SQL
        env:
          MIGRATION_ID: ${{ needs.preparation.outputs.migration-id }}
        run: |
          node scripts/generate-migration-sql.js
          
          echo "âœ… Scripts gerados:"
          ls -la supabase/migrations/
          
      - name: ğŸ“¤ Upload scripts
        uses: actions/upload-artifact@v4
        with:
          name: migration-scripts-${{ needs.preparation.outputs.migration-id }}
          path: supabase/migrations/
          retention-days: 7

  # Job 4: MigraÃ§Ã£o de Schema (paralela)
  schema-migration:
    name: ğŸ—„ï¸ MigraÃ§Ã£o de Schema
    runs-on: ubuntu-latest
    needs: [preparation, backup, generate-scripts]
    if: always() && (needs.backup.result == 'success' || needs.backup.result == 'skipped') && needs.generate-scripts.result == 'success'
    timeout-minutes: 180
    
    strategy:
      matrix:
        table: [cart_items, customers, orders, order_items, tickets, profiles, rls_performance_metrics]
      fail-fast: false
      max-parallel: 3
      
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          npm install -g supabase@${{ env.SUPABASE_CLI_VERSION }}
          
      - name: ğŸ“¥ Download scripts
        uses: actions/download-artifact@v4
        with:
          name: migration-scripts-${{ needs.preparation.outputs.migration-id }}
          path: supabase/migrations/
          
      - name: ğŸ” Configurar credenciais
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase login --token $SUPABASE_ACCESS_TOKEN
          supabase link --project-ref $SUPABASE_PROJECT_ID
          
      - name: ğŸ—„ï¸ Migrar tabela ${{ matrix.table }}
        env:
          TABLE: ${{ matrix.table }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "ğŸ” [DRY RUN] Migrando tabela: $TABLE"
            cat "supabase/migrations/migrate_${TABLE}.sql"
          else
            echo "ğŸ”„ Migrando tabela: $TABLE"
            supabase db reset --file "supabase/migrations/migrate_${TABLE}.sql"
          fi
          
      - name: âœ… Verificar migraÃ§Ã£o
        env:
          TABLE: ${{ matrix.table }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node -e "
            const { createClient } = require('@supabase/supabase-js');
            const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);
            
            async function verify() {
              try {
                const { data, error } = await supabase.rpc('execute_sql', {
                  query: \`SELECT COUNT(*) as count FROM information_schema.tables WHERE table_name = '${process.env.TABLE}'\`
                });
                
                if (error) throw error;
                
                const exists = data[0]?.count > 0;
                console.log(\`âœ… Tabela ${process.env.TABLE}: \${exists ? 'EXISTE' : 'NÃƒO ENCONTRADA'}\`);
                
                if (!exists) process.exit(1);
              } catch (error) {
                console.error('âŒ Erro na verificaÃ§Ã£o:', error.message);
                process.exit(1);
              }
            }
            
            verify();
          "

  # Job 5: ValidaÃ§Ã£o (apÃ³s migraÃ§Ã£o de schema)
  validation:
    name: ğŸ§ª ValidaÃ§Ã£o e Testes
    runs-on: ubuntu-latest
    needs: [preparation, schema-migration]
    if: always() && needs.schema-migration.result == 'success'
    timeout-minutes: 60
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
        
      - name: ğŸ§ª Executar testes de integridade
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node scripts/validate-migration.js
          
      - name: ğŸ“Š Gerar relatÃ³rio de validaÃ§Ã£o
        if: always()
        run: |
          echo "ğŸ“‹ RelatÃ³rio de ValidaÃ§Ã£o" > validation-report.md
          echo "========================" >> validation-report.md
          echo "" >> validation-report.md
          
          if [[ -f "reports/validation_*.json" ]]; then
            node -e "
              const fs = require('fs');
              const files = fs.readdirSync('reports').filter(f => f.startsWith('validation_'));
              const latest = files.sort().pop();
              const report = JSON.parse(fs.readFileSync(\`reports/\${latest}\`, 'utf8'));
              
              console.log(\`âœ… Testes aprovados: \${report.summary.passed}\`);
              console.log(\`âŒ Testes falharam: \${report.summary.failed}\`);
              console.log(\`ğŸš¨ Falhas crÃ­ticas: \${report.summary.critical_failures}\`);
            " >> validation-report.md
          fi
          
      - name: ğŸ“¤ Upload relatÃ³rio
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report-${{ needs.preparation.outputs.migration-id }}
          path: |
            validation-report.md
            reports/
          retention-days: 30

  # Job 6: Deploy (apenas se validaÃ§Ã£o passou)
  deploy:
    name: ğŸš€ Deploy e FinalizaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [preparation, validation]
    if: needs.validation.result == 'success' && inputs.dry_run == false
    timeout-minutes: 30
    
    environment:
      name: ${{ inputs.environment }}
      
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          npm install -g supabase@${{ env.SUPABASE_CLI_VERSION }}
          
      - name: ğŸ” Configurar credenciais
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase login --token $SUPABASE_ACCESS_TOKEN
          supabase link --project-ref $SUPABASE_PROJECT_ID
          
      - name: ğŸš€ Deploy Edge Functions
        run: |
          supabase functions deploy --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
          
      - name: ğŸ“Š Configurar monitoramento
        run: |
          echo "ğŸ” Configurando alertas de monitoramento..."
          # Implementar configuraÃ§Ã£o de alertas
          
      - name: ğŸ“¢ Notificar conclusÃ£o
        env:
          MIGRATION_ID: ${{ needs.preparation.outputs.migration-id }}
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [[ -n "$WEBHOOK_URL" ]]; then
            curl -X POST "$WEBHOOK_URL" \
              -H 'Content-type: application/json' \
              --data '{
                "text": "âœ… MigraÃ§Ã£o de banco de dados concluÃ­da com sucesso!",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*MigraÃ§Ã£o de Banco de Dados ConcluÃ­da* âœ…\n\n*ID:* '"$MIGRATION_ID"'\n*Ambiente:* '"${{ inputs.environment }}"'\n*Tipo:* '"${{ inputs.migration_type }}"'"
                    }
                  }
                ]
              }'
          fi

  # Job 7: Rollback (manual, apenas em caso de falha)
  rollback:
    name: ğŸ”„ Rollback (Manual)
    runs-on: ubuntu-latest
    needs: [preparation, backup]
    if: failure() && needs.backup.result == 'success'
    when: manual
    timeout-minutes: 60
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“¦ Instalar Supabase CLI
        run: npm install -g supabase@${{ env.SUPABASE_CLI_VERSION }}
        
      - name: ğŸ“¥ Download backup
        uses: actions/download-artifact@v4
        with:
          name: database-backup-${{ needs.preparation.outputs.migration-id }}
          path: backups/
          
      - name: ğŸ” Configurar credenciais
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase login --token $SUPABASE_ACCESS_TOKEN
          supabase link --project-ref $SUPABASE_PROJECT_ID
          
      - name: ğŸ”„ Executar rollback
        env:
          MIGRATION_ID: ${{ needs.preparation.outputs.migration-id }}
        run: |
          echo "ğŸ”„ Executando rollback..."
          
          BACKUP_FILE="backups/backup_${MIGRATION_ID}.sql"
          
          if [[ ! -f "$BACKUP_FILE" ]]; then
            echo "âŒ Arquivo de backup nÃ£o encontrado: $BACKUP_FILE"
            exit 1
          fi
          
          # Restaurar backup
          supabase db reset --file "$BACKUP_FILE"
          
          echo "âœ… Rollback concluÃ­do"
          
      - name: ğŸ“¢ Notificar rollback
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          MIGRATION_ID: ${{ needs.preparation.outputs.migration-id }}
        run: |
          if [[ -n "$WEBHOOK_URL" ]]; then
            curl -X POST "$WEBHOOK_URL" \
              -H 'Content-type: application/json' \
              --data '{
                "text": "ğŸ”„ Rollback de migraÃ§Ã£o executado",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Rollback Executado* ğŸ”„\n\n*ID:* '"$MIGRATION_ID"'\n*Ambiente:* '"${{ inputs.environment }}"'\n*Motivo:* Falha na migraÃ§Ã£o"
                    }
                  }
                ]
              }'
          fi