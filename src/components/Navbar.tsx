
import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { ShoppingCart, Calendar, Shirt, User } from 'lucide-react';
import ButterflyLogo from './ButterflyLogo';
import { Button } from '@/components/ui/button';
import { useCart } from '@/contexts/CartContext';
import { useAuth } from '@/hooks/useAuth';
import MobileMenu from './MobileMenu';


const Navbar: React.FC = () => {
  const { items } = useCart();
  const { user, signOut, isAdmin } = useAuth();
  const [userIsAdmin, setUserIsAdmin] = useState(false);

  useEffect(() => {
    const checkAdminStatus = async () => {
      if (user) {
        const adminStatus = await isAdmin();
        setUserIsAdmin(adminStatus);
      } else {
        setUserIsAdmin(false);
      }
    };

    checkAdminStatus();
  }, [user, isAdmin]);
  
  // Calculate total quantity by summing up all item quantities
  const cartItemsCount = items.reduce((total, item) => total + item.quantity, 0);
  
  return (
    <nav className="sticky top-0 z-50 w-full bg-white shadow-sm border-b border-butterfly-orange/10">
      <div className="container mx-auto px-4 py-1">
        <div className="flex items-center justify-between">
          <div className="flex items-center">
            <MobileMenu />
            <div className="ml-12">
              <Link 
                to="/" 
                className="text-butterfly-orange"
              >
                <div className="w-24 h-24">
                <svg xmlns="http://www.w3.org/2000/svg" xmlnsXlink="http://www.w3.org/1999/xlink" width="1360" height="518" viewBox="0 0 1360 518" className="w-full h-full">
                  <path fill="#FFAB00" d="M461.133 104.528C482.831 102.272 509.992 107.065 527.68 119.828C558.604 142.141 564.684 183.207 562.272 218.67C560.373 246.599 551.122 274.465 526.626 290.398C511.351 300.335 497.274 302.314 479.94 305.085C503.961 311.091 511.937 313.126 520.255 338.727C522.729 346.341 525.455 353.491 534.656 353.55C547.72 353.632 543.496 336.237 547.948 331.708C551.275 331.538 552.2 331.111 553.817 334.017C553.928 335.357 553.928 336.527 553.611 337.845C550.23 351.924 544.308 360.735 531.188 366.8C501.391 377.289 473.954 365.251 465.627 334.017C458.431 307.026 450.038 310.033 431.4 325.03L427.437 320.524C436.81 311.532 443.424 309.271 455.439 305.902C436.776 302.682 421.378 299.831 406.054 287.294C387.046 271.718 378.405 248.073 376.174 224.31C372.283 182.865 382.455 135.441 422.609 114.674C435.273 108.124 447.211 105.803 461.133 104.528ZM474.174 300.631C481.898 299.468 489.247 296.868 494.03 290.303C508.296 270.717 506.327 168.012 501.962 141.615C500.452 132.482 496.956 120.98 489.053 115.32C481.679 110.038 472.424 109.967 463.733 110.431C455.638 111.731 449.58 113.575 444.633 120.651C434.267 135.482 433.624 158.143 433.459 175.773C433.182 205.447 431.969 235.701 435.671 265.155C438.715 288.431 449.17 302.742 474.174 300.631Z"/>
                  <path fill="#FFAB00" d="M723.081 169.717C724.228 171.158 723.778 287.59 723.777 298.362C727.141 298.419 735.648 297.693 737.942 299.053C739.427 300.876 739.181 300.085 739.363 302.325C736.593 304.5 682.707 303.54 674.997 303.52C674.187 297.067 673.006 290.268 671.982 283.815C669.594 288.199 667.141 292.525 663.634 296.111C649.465 310.707 614.773 309.573 600.723 295.588C586.407 281.337 588.777 256.362 588.783 237.604L588.823 189.103L588.811 174.792C585.753 174.822 576.099 175.28 573.884 174.227C572.738 172.408 572.959 173.25 573.121 171.024C575.672 168.865 593.099 169.825 597.714 169.822L641.103 169.725C642.285 205.689 640.194 242.45 641.681 278.432C641.857 285.069 644.024 294.457 652.799 293.542C675.797 291.143 671.447 250.617 671.438 234.838L671.363 174.792C666.929 174.859 660.299 176.292 658.238 172.03L658.821 170.582C664.226 168.843 714.518 169.749 723.081 169.717Z"/>
                  <path fill="#FFAB00" d="M123.287 148.333C130.036 151.278 132.344 157.208 135.907 163.377C177.838 168.22 220.316 158.317 262.977 168.938C309.261 180.461 296.328 223.945 296.723 261.059C295.765 290.173 300.395 318.89 294.757 347.665C292.872 357.291 271.163 390.611 263.916 388.553L262.748 384.965C259.309 355.478 265.24 316.978 265.443 286.094C265.573 266.419 267.708 228.498 254.199 211.981C249.889 207.996 240.234 204.848 234.824 204.28C186.16 199.17 135.567 202.434 86.7717 202.663C97.1882 174.24 111.185 170.436 123.287 148.333Z"/>
                  <path fill="#FFAB00" d="M811.788 167.625C814.288 167.481 816.791 167.399 819.296 167.38C863.062 167.444 880.102 189.847 879.766 231.587L800.459 231.721C800.592 264.404 800.486 313.606 852.13 293.672C863.591 289.248 870.391 275.599 874.193 264.483L875.246 263.528C877.43 263.682 877.401 263.352 878.99 264.417C879.623 270.143 871.868 283.273 868.183 287.921C858.292 300.33 844.889 304.911 829.641 306.362C786.743 310.446 751.086 293.531 746.618 246.75C742.241 200.92 765.612 171.828 811.788 167.625ZM800.786 225.842L816.458 225.841L829.47 225.827C829.524 216.606 829.796 207.061 829.353 197.872C828.874 187.939 828.472 172.868 815.239 172.734C797.453 177.065 800.684 211.252 800.786 225.842Z"/>
                  <path fill="#FF8600" d="M1093.57 167.633C1118.83 165.471 1147.57 172.702 1157.22 198.791C1161.5 210.36 1161.83 219.513 1161.66 231.575C1135.47 231.953 1108.75 231.56 1082.46 231.721C1082.42 264.315 1082.63 312.876 1133.15 294.105C1146.16 289.274 1152.22 275.594 1156.69 263.326C1157.75 263.451 1159.09 263.72 1160.17 263.903C1160.42 264.218 1161.19 265.037 1161.11 265.375C1154.97 290.999 1136.21 304.225 1112.08 306.394C1068.78 310.287 1033.42 293.842 1028.71 247.369C1026.71 227.647 1029.39 207.486 1042.18 191.656C1055.38 175.771 1073.52 169.57 1093.57 167.633ZM1082.7 225.842L1097.36 225.841L1111.56 225.828C1111.62 216.06 1111.9 205.961 1111.27 196.234C1110.63 186.424 1110.12 173.357 1097.55 172.72C1093.29 173.671 1090.7 174.722 1088.23 178.75C1081.62 189.533 1082.65 213.213 1082.7 225.842Z"/>
                  <path fill="#FFAB00" d="M231.315 120.199C236.083 120.108 259.16 125.674 263.4 127.373C339.022 157.679 383.086 262.108 354.849 337.806C339.38 379.275 301.86 419.2 262.567 437.644C250.316 443.438 239.625 445.245 226.48 447.089C263.538 425.849 286.682 410.831 304.643 369.896C323.07 327.238 323.599 280.023 315.422 234.949C310.758 209.239 307.286 200.89 293.929 179.149C276.97 151.542 261.412 133.308 231.315 120.199Z"/>
                  <path fill="#FFAB00" d="M991.505 167.561C1015.3 166.129 1028.18 180.349 1024.28 204.65C1020.84 226.021 993.762 231.142 980.56 215.37C976.051 209.983 977.807 199.158 979.266 192.532L989.736 192.423C997.131 172.787 979.683 175.523 970.789 184.583C955.054 200.608 957.508 227.338 957.52 247.79L957.572 298.906C961.53 298.966 974.735 298.039 977.29 299.728C977.537 301.323 977.635 301.643 976.912 303.137C974.453 304.987 967.829 304.222 964.551 304.11L915.172 304.113C909.416 304.108 895.696 304.448 890.453 303.872L889.759 302.779C889.993 300.502 889.611 301.274 891.133 299.584C894.464 298.227 901.103 298.809 905.12 298.868C905.909 258.596 905.197 215.839 905.169 175.35C900.189 175.39 892.401 176.712 889.271 172.974L889.764 171.311C893.236 169.352 950.501 170.267 957.536 170.289L957.59 195.964C964.001 178.758 973.05 170.235 991.505 167.561Z"/>
                  <path fill="#FFAB00" d="M599.976 321.087C608.664 321.057 646.395 319.818 652.092 322.695L651.481 323.572C648.27 324.537 644.882 324.456 641.517 324.56L641.531 380.126C651.706 380.62 667.079 380.385 677.275 380.046C677.494 361.605 677.307 342.795 677.311 324.325C672.98 324.464 670.881 324.86 666.923 322.968L666.754 322.209C673.903 319.864 704.37 321.416 713.804 320.884C715.535 320.786 720.945 322.004 722.871 322.526L723.078 323.533C719.302 324.424 716.35 324.436 712.471 324.563L712.5 443.604C716.216 443.521 719.401 443.11 722.632 444.943L722.872 445.949C721.254 447.241 719.328 446.993 717.239 446.99L684.227 447.031C679.7 447.015 671.349 447.216 667.077 446.705L666.691 445.613L667.413 444.327C669.81 443.222 674.436 443.573 677.281 443.611L677.305 385.059C665.375 384.936 653.444 384.956 641.514 385.121L641.526 443.598C646.245 443.552 647.608 443.199 652.005 445.148L652.04 446.278L652.905 445.886L652.087 445.27L651.515 446.394C644.319 447.512 603.481 447.258 595.973 446.356L595.503 445.466C598.25 443.201 602.948 443.535 606.294 443.609L606.318 324.343C603.51 324.463 597.369 325.019 595.664 322.419C597.581 320.93 597.21 321.375 599.976 321.087Z"/>
                  <path fill="#FFAB00" d="M891.857 359.49C892.666 359.446 893.476 359.439 894.286 359.468C921.773 360.312 926.939 385.903 926.298 408.548C925.956 433.812 912.185 451.014 885.676 448.768C877.811 448.102 874.793 446.841 869.321 440.741L869.268 486.649C873.893 486.631 890.225 485.753 892.83 488.52C890.963 490.226 873.604 489.86 869.756 489.9C857.406 489.925 836.819 491.108 825.982 488.413L825.901 487.41L824.876 487.719L825.907 488.227L826.453 487.278C829.311 486.613 832.558 486.708 835.518 486.662C835.943 446.304 835.548 404.986 835.548 364.564C831.354 364.638 829.797 365.039 826.106 362.997L826.12 362.315C831.272 360.769 861.38 361.286 868.832 361.311C868.758 365.731 868.953 370.096 869.117 374.51C875.082 364.212 880.089 360.94 891.857 359.49ZM880.109 443.754C890.838 442.484 890.925 428.295 891.236 419.637C891.731 405.898 891.763 391.64 890.399 377.976C889.689 371.672 888.32 367.483 881.299 367.166C876.066 369.558 873.461 373.232 871.516 378.522C867.936 388.258 867.42 427.415 871.901 436.945C873.28 439.877 875.121 442.094 878.24 443.175C878.857 443.386 879.481 443.579 880.109 443.754Z"/>
                  <path fill="#FF8600" d="M1077.04 359.543C1088.12 358.811 1094.07 361.855 1100.79 370.309L1101.94 361.307C1107.47 361.293 1141.35 360.507 1143.26 362.52L1142.73 363.672C1140.88 365.185 1135.84 364.678 1133.2 364.633L1133.15 486.634C1136.08 486.596 1140.3 486.144 1142.2 488.709C1136.77 490.67 1104.93 489.955 1097.62 489.784C1094.19 489.857 1084.36 490.372 1081.98 488.312C1084.62 486.012 1095.79 486.614 1099.59 486.668L1099.6 433.983C1095.03 442.277 1089.51 447.541 1079.88 448.639C1056.88 451.263 1044.44 434.841 1042.87 413.354C1041.85 399.386 1042.09 382.561 1051.54 370.917C1058.33 362.533 1066.76 360.49 1077.04 359.543ZM1089.76 440.397C1104.45 429.79 1098.62 401.765 1099.76 385.68C1100.37 376.933 1097.07 365.296 1086.39 364.607C1074.03 370.266 1077.85 403.619 1077.45 415.552C1077.16 423.989 1076.63 444.085 1089.76 440.397Z"/>
                  <path fill="#FF8600" d="M1145.66 361.596C1158.54 360.818 1176.03 361.301 1189.28 361.326C1189.46 372.53 1187.08 433.568 1192.17 438.901C1193.3 440.077 1194.95 440.537 1196.53 440.591C1199.04 440.677 1201.03 439.802 1202.8 438.028C1205.67 435.158 1207.17 430.726 1207.9 426.812C1209.36 419.004 1208.7 410.42 1208.69 402.496L1208.6 364.531C1206.09 364.593 1201.47 365.131 1200.42 362.361C1204.41 360.748 1235.71 361.295 1242.22 361.317C1242.36 368.881 1242.32 376.605 1242.35 384.183L1242.32 443.743C1245.21 443.768 1251.5 442.788 1252.12 445.883C1249.35 447.684 1216.87 447.048 1210.9 447.048C1210.55 443.16 1209.6 438.537 1208.91 434.627C1202.83 445.898 1196.55 448.754 1184.01 448.868C1152.74 449.153 1155.51 421.875 1155.58 399.771L1155.65 364.563C1152.53 364.702 1148.06 365.362 1145.67 363.602L1145.66 361.596Z"/>
                  <path fill="#FFAB00" d="M930.817 361.61C944.841 361.033 960.078 361.298 974.215 361.322C974.431 372.228 972.171 433.857 977.05 438.812C978.297 440.078 980.385 440.615 982.111 440.609C984.438 440.6 986.295 439.626 987.892 437.965C990.686 435.059 992.169 430.667 992.883 426.771C994.287 419.116 993.645 410.715 993.636 402.95L993.545 364.535C990.433 364.656 987.33 365.186 985.29 362.438C989.069 360.694 1020.82 361.297 1027.23 361.318L1027.3 384.183L1027.28 443.744C1030.88 443.709 1034.61 443.033 1037.17 445.11L1037.19 446.09C1033.7 447.79 1002.07 447.077 995.974 447.055C995.414 442.976 994.66 438.812 993.972 434.742C987.75 446.082 981.438 448.58 968.938 448.837C947.78 449.273 940.144 435.421 940.716 415.907C940.839 411.676 940.7 406.069 940.703 401.599L940.759 364.567C936.786 364.714 931.036 366.21 930.817 361.61Z"/>
                  <path fill="#FFAB00" d="M770.745 359.568C819.031 357.747 809.81 386.444 810.75 422.717C810.87 427.322 809.215 441.726 817.459 438.902C821.439 435.21 822.725 427.088 824.385 421.517L824.947 421.216C825.537 429.689 824.041 442.916 815.378 446.268C802.059 451.42 784.702 450.05 777.886 436.398C777.776 436.62 777.664 436.84 777.55 437.06C769.731 452.112 751.813 451.436 738.562 444.453C729.458 437.21 727.081 421.329 735.779 412.992C744.893 404.256 764.808 404.672 777.072 404.776C777.152 393.468 778.933 373.149 772.785 363.855C768.666 357.627 753.424 367.252 761.228 374.115C762.948 374.256 763.653 374.212 765.188 375.026C766.186 377.065 766.582 378.293 766.779 380.584C767.124 384.529 765.876 388.448 763.315 391.467C755.808 400.298 735.456 398.369 735.27 383.208C735.013 362.188 755.03 360.333 770.745 359.568ZM766.701 441.069C774.673 442.184 776.071 435.164 776.9 428.713C777.286 425.707 777.646 410.081 776.806 407.297C773.217 407.829 770.543 408.195 768.188 411.358C763.231 418.013 763.876 433.84 766.701 441.069Z"/>
                  <path fill="#FFAB00" d="M143.827 229.614C144.513 233.294 144.572 250.926 144.701 255.503C145.443 281.823 147.154 310.988 142.3 336.909C138.143 359.113 129.481 375.536 110.587 388.259L110.109 388.288C108.227 385.615 111.08 286.642 110.472 275.096C109.728 260.957 131.651 238.435 143.827 229.614Z"/>
                  <path fill="#FFAB00" d="M21.1515 261.175C26.5644 197.86 95.7972 118.737 161.928 116.177C123.703 129.854 95.5736 163.837 78.4688 199.353C55.7327 246.561 57.7171 307.889 74.8129 355.987C89.5547 397.462 113.872 425.636 153.638 443.637C163.094 447.918 172.705 454.316 182.403 458.435C225.652 479.691 266.901 483.431 314.137 476.141C326.047 474.303 340.591 472.873 352.548 470.137C326.983 487.126 310.798 494.527 280.107 500.018C268.637 502.273 262.474 501.391 251.305 501.792C237.07 502.303 228.729 499.83 215.068 497.215C165.517 487.731 131.141 455.185 88.145 431.305C78.7723 426.043 69.1606 421.218 59.341 416.846C45.8806 411.003 35.7755 407.766 23.0063 400.17C39.7122 398.644 54.3686 403.005 70.9247 405.17C62.7733 390.832 57.1084 386.766 47.888 374.59C33.2788 355.299 23.9189 323.7 19.7798 300.102C18.6087 293.426 19.1265 272.322 19.4622 264.681C19.5081 263.636 20.4978 262.065 21.1515 261.175Z"/>
                  <path fill="#FF8600" d="M1240.26 195.031C1249.46 174.822 1259.64 167.228 1282.12 167.389C1329.18 167.726 1325.57 205.058 1325.56 239.401L1325.52 298.921C1330.51 298.888 1338.05 298.603 1342.72 299.703L1342.66 303.699C1333.22 305.673 1277.83 303.349 1264.18 303.797C1262.19 303.862 1261.93 302.875 1260.83 301.377C1264.69 298.148 1268.12 298.772 1273.07 298.874C1274.03 266.266 1272.75 232.902 1273.03 200.315C1273.1 192.955 1271.73 179.657 1262.65 180.924C1236.85 184.527 1240.14 229.549 1240.15 244.724L1240.12 298.908C1243.78 298.883 1247.44 298.939 1251.1 299.074C1252.55 300.199 1252.07 299.636 1252.8 301.614C1249.87 305.675 1236.91 304.097 1231.9 304.081C1213.22 304.021 1194.53 304.286 1175.85 304.001C1173.95 303.972 1173.8 303.767 1172.33 302.706C1172.13 300.927 1172.06 301.568 1173.41 299.844C1176.75 298.205 1183.58 298.834 1187.77 298.875C1188.28 258.162 1187.83 216.155 1187.83 175.352C1185.13 175.363 1174.66 175.501 1172.64 174.812C1172.24 172.727 1172.13 173.582 1173.12 171.59C1177.34 168.895 1190.27 170.297 1195.89 170.293C1210.6 170.186 1225.3 170.19 1240.01 170.305C1240.3 178.292 1240.2 186.988 1240.26 195.031Z"/>
                  <path fill="#FFAB00" d="M103.45 23.327C104.932 21.9893 105.829 20.8805 108.153 21.1022C114.236 21.6823 118.51 24.2269 118.036 30.8937C117.333 40.7974 111.932 46.154 122.605 52.1468C137.336 60.6584 156.309 65.9729 170.665 53.7669C178.885 46.7771 182.586 38.2184 186.283 28.2877C188.392 22.6241 187.423 21.4086 193.022 21.4145C196.009 23.3934 197.682 33.497 199.48 37.3362C215.376 71.2612 243.02 64.3622 267.561 44.8906C265.445 39.4363 264.287 36.4076 263.851 30.5545C266.043 26.6255 268.006 24.6477 271.038 21.3067C281.19 20.791 282.102 24.2623 284.928 24.4458C285.123 24.9628 285.309 25.4837 285.484 26.008C287.863 33.1986 281.198 39.5635 276.582 44.2601C269.823 50.7361 267.61 60.7283 264.862 69.4229C260.951 81.7978 257.675 92.9353 251.763 104.593C212.722 105.648 169.059 104.727 129.67 104.769C123.706 87.3306 119.513 68.7747 112.143 51.937C109.201 45.2155 98.9878 39.9583 97.3032 33.6185C97.5393 29.5138 100.802 26.3884 103.45 23.327ZM194.601 98.0184C206.799 89.9756 206.653 59.5016 192.676 56.1982C179.656 64.4822 180.911 96.5957 194.601 98.0184Z"/>
                  <path fill="#FF8600" d="M1341.37 425.019C1340.97 425.89 1340.57 426.758 1340.16 427.624C1336.1 436.222 1330.04 443.518 1320.78 446.373C1298.17 452.74 1267.88 448.283 1259.49 422.43C1244.91 377.517 1282.84 347.35 1324.88 363.82C1333.83 367.327 1338.44 376.485 1341.35 385.344C1343.63 387.807 1342.86 396.822 1342.78 400.577C1326.16 400.557 1308.02 400.17 1291.52 400.648C1291.54 416.533 1290.12 444.238 1312.98 443.155C1320.19 442.813 1326.54 440.514 1331.61 435.231C1334.6 432.168 1337.34 423.565 1340.11 421.256L1341.47 421.308L1342.14 422.346L1341.37 425.019ZM1291.63 397.05L1304.13 397.066L1310.12 396.919C1310.13 387.982 1312.95 362.922 1300.68 363.14C1300.01 363.152 1299.35 363.176 1298.68 363.21C1289.91 370.563 1291.57 386.388 1291.63 397.05Z"/>
                </svg>
              </div>
              </Link>
            </div>
          </div>

          <div className="hidden md:flex items-center space-x-1">
            <Link to="/" className="px-3 py-2 rounded-md text-base font-medium hover:bg-butterfly-orange/10 transition-colors">
              Home
            </Link>
            <Link to="/evento" className="px-3 py-2 rounded-md text-base font-medium hover:bg-butterfly-orange/10 transition-colors flex items-center">
              <Calendar className="mr-1 h-4 w-4" /> Evento
            </Link>
            <Link to="/loja" className="px-3 py-2 rounded-md text-base font-medium hover:bg-butterfly-orange/10 transition-colors flex items-center">
              <Shirt className="mr-1 h-4 w-4" /> Loja
            </Link>
            <Link to="/checkout" className="px-3 py-2 rounded-md text-base font-medium hover:bg-butterfly-orange/10 transition-colors">
              Checkout
            </Link>
            {userIsAdmin && (
              <Link to="/admin" className="px-3 py-2 rounded-md text-base font-medium hover:bg-butterfly-orange/10 transition-colors">
                Admin
              </Link>
            )}
            <Link to="/ingressos" className="px-3 py-2 rounded-md text-base font-medium hover:bg-butterfly-orange/10 transition-colors flex items-center">
              <Calendar className="mr-1 h-4 w-4" /> Ingressos
            </Link>
          </div>

          <div className="flex items-center space-x-9">
            {/* Ícone de login para mobile */}
            {!user && (
              <Link 
                to="/auth" 
                className="md:hidden text-butterfly-orange hover:text-butterfly-orange/80 transition-colors"
                title="Entrar"
              >
                <User className="h-6 w-6" />
              </Link>
            )}

            <Link to="/carrinho" className="relative text-butterfly-orange hover:text-butterfly-orange/80 transition-colors" data-testid="cart-icon">
              <ShoppingCart className="h-6 w-6" />
              {cartItemsCount > 0 && (
                <div className="absolute -top-2 -right-2 bg-butterfly-orange text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                  {cartItemsCount}
                </div>
              )}
            </Link>
            
            {user ? (
              <Link 
                to="/perfil"
                className="hidden md:flex items-center space-x-2 text-butterfly-orange hover:text-butterfly-orange/80 transition-colors"
              >
                <User className="h-5 w-5" />
                <div className="font-medium">Perfil</div>
              </Link>
            ) : (
              <Button 
                variant="default" 
                className="hidden md:flex"
                onClick={() => window.location.href = '/auth'}
              >
                Entrar
              </Button>
            )}
            

          </div>
        </div>
      </div>
    </nav>
  );
};

export default Navbar;